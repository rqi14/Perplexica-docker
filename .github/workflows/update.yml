name: Sync and Build Docker Image

on:
  schedule:
    # Runs at 00:00 UTC every day
    - cron: '0 0 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Git
        run: |
          git config --global user.name 'rqi14'
          git config --global user.email 'rqi14@example.com'
          git remote add upstream https://github.com/ItzCrazyKns/Perplexica.git || true
          git fetch upstream

      - name: Check if repository is up-to-date
        id: check-up-to-date
        run: |
          LOCAL=$(git rev-parse @)
          REMOTE=$(git rev-parse "upstream/main")
          BASE=$(git merge-base @ "upstream/main")
          if [ $LOCAL = $REMOTE ]; then
            echo "Repository is up-to-date"
            echo "REPO_SYNCED=true" >> $GITHUB_ENV
          elif [ $LOCAL = $BASE ]; then
            echo "Need to sync"
            echo "REPO_SYNCED=false" >> $GITHUB_ENV

      - name: Rebase with upstream
        if: env.REPO_SYNCED == 'false'
        run: |
          git rebase upstream/main || (echo "Conflicts detected during rebase. Manual intervention required." && exit 1)
          git push --force-with-lease

  build-and-push:
    needs: sync
    if: needs.sync.outputs.REPO_SYNCED == 'false'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - dockerfile: 'frontend.dockerfile'
            image_name: 'perplexica-app'
            http_probe_ports: '3000'
            expose_ports: '3000'
          - dockerfile: 'backend.dockerfile'
            image_name: 'perplexica-backend'
            http_probe_ports: '3001'
            expose_ports: '3001'
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # Docker build, DockerSlim, Docker Hub login, and push operations as detailed previously
